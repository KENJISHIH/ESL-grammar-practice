<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Grammar Practice</title>

    <!-- ========================================== -->
    <!-- 1. è³‡æ–™åº«åˆå§‹åŒ–èˆ‡è¼‰å…¥ -->
    <!-- ========================================== -->
    <script>
        // å»ºç«‹ä¸€å€‹ç©ºçš„è³‡æ–™åº«ï¼Œè®“å¾Œé¢çš„æª”æ¡ˆå¡«å…¥è³‡æ–™
        window.grammarDatabase = {}; 
    </script>

    <!-- é€™è£¡è¼‰å…¥ä½ çš„å–®å…ƒæª” (ç¢ºèªæª”æ¡ˆæœ‰ä¸Šå‚³åˆ° GitHub) -->
    <script src="unit1.js"></script>
    <script src="unit6.js"></script>
    
    <!-- æœªä¾†æœ‰æ–°å–®å…ƒï¼Œè«‹è§£é–‹ä¸‹é¢çš„è¨»è§£æˆ–æ–°å¢ä¸€è¡Œ -->
    <!-- <script src="unit2.js"></script> -->
    <!-- <script src="unit3.js"></script> -->
    <!-- <script src="unit4.js"></script> -->
    <!-- <script src="unit5.js"></script> -->
    <!-- <script src="unit7.js"></script> -->

    <style>
        :root {
            --primary: #3498db;
            --secondary: #f1c40f;
            --accent: #e74c3c;
            --success: #2ecc71;
            --bg: #f5f6fa;
            --text: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- é ‚éƒ¨æ§åˆ¶å€ --- */
        .header-controls {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        h2 { margin: 0; color: var(--primary); font-size: 1.5em; }

        select {
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--primary);
            background: white;
            font-weight: bold;
            color: var(--text);
            cursor: pointer;
        }

        /* --- å°è¦½åˆ†é  --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 8px 16px;
            background: #dfe6e9;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #636e72;
            transition: 0.3s;
            font-size: 0.95em;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }

        /* --- éŠæˆ²ä¸»ç•«é¢ --- */
        .game-area {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            text-align: center;
            min-height: 300px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-text {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 30px;
            color: var(--text);
            min-height: 1.2em;
            line-height: 1.4;
        }

        /* æ¨¡å¼ A: Choice (æŒ‰éˆ•é¸é …) */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* å¦‚æœé¸é …å¤ªé•·ï¼Œè‡ªå‹•è®Šå–®æ¬„ */
        @media (max-width: 400px) {
            .options-grid { grid-template-columns: 1fr; }
        }

        .option-btn {
            background: white;
            border: 3px solid #eee;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            color: #555;
            user-select: none;
        }

        .option-btn:hover { border-color: var(--primary); background: #ebf5fb; }
        
        .option-btn.correct { background: #d4edda !important; border-color: var(--success) !important; color: var(--success) !important; }
        .option-btn.wrong { background: #f8d7da !important; border-color: var(--accent) !important; color: var(--accent) !important; }

        /* æ¨¡å¼ B: Sorting (åˆ†é¡) */
        .sorting-item {
            font-size: 3em;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0 40px 0;
            animation: popIn 0.5s;
        }

        .buckets-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .bucket-btn {
            background: #fdfdfd;
            border: 2px dashed #b2bec3;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1em;
            cursor: pointer;
            color: #636e72;
            font-weight: bold;
        }
        
        .bucket-btn:hover { border-color: var(--primary); color: var(--primary); }
        .bucket-btn.correct-bucket { background: var(--success); color: white; border-style: solid; }
        .bucket-btn.wrong-bucket { background: var(--accent); color: white; border-style: solid; }

        /* --- é€šç”¨å›é¥‹ --- */
        .feedback-msg {
            margin-top: 25px;
            font-size: 1.2em;
            font-weight: bold;
            height: 1.5em;
        }

        .next-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            margin-top: 20px;
            cursor: pointer;
            display: none; /* ç­”å°å¾Œé¡¯ç¤º */
            box-shadow: 0 4px 0 #2980b9;
        }

        .next-btn:active { transform: translateY(4px); box-shadow: none; }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .progress-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .loading-msg {
            color: #7f8c8d;
            margin-top: 50px;
        }

    </style>
</head>
<body>

    <div class="header-controls">
        <h2>Grammar Practice</h2>
        <select id="unit-selector" onchange="loadUnit(this.value)">
            <option value="" disabled selected>Select a Unit...</option>
            <!-- JS æœƒè‡ªå‹•å¡«å…¥é¸é … -->
        </select>
    </div>

    <div id="tabs-container" class="tabs">
        <!-- JS æœƒè‡ªå‹•ç”Ÿæˆåˆ†é æŒ‰éˆ• -->
    </div>

    <div class="game-area">
        <div id="progress" class="progress-indicator"></div>
        
        <!-- é¡Œç›®é¡¯ç¤ºå€ -->
        <div id="question-display" class="question-text">
            <div class="loading-msg">Please select a unit to start.</div>
        </div>
        
        <!-- éŠæˆ²äº’å‹•å€ (æœƒæ ¹æ“šæ¨¡å¼æ”¹è®Š) -->
        <div id="interaction-area"></div>

        <!-- å›é¥‹å€ -->
        <div id="feedback" class="feedback-msg"></div>
        <button id="btn-next" class="next-btn" onclick="nextQuestion()">Next Question â¡</button>
    </div>

    <script>
        // ==========================================
        // æ ¸å¿ƒå¼•æ“ (Game Engine)
        // ==========================================
        
        let currentUnitKey = "";
        let currentSectionIndex = 0;
        let currentQuestionIndex = 0;
        let currentData = null; // ç•¶å‰æ­£åœ¨ç©çš„ Section è³‡æ–™

        // åˆå§‹åŒ–ï¼šç•¶ç¶²é è¼‰å…¥å®Œæˆæ™‚
        window.onload = function() {
            // 1. æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰æ±è¥¿
            const db = window.grammarDatabase;
            const selector = document.getElementById('unit-selector');

            if (!db || Object.keys(db).length === 0) {
                alert("No unit data loaded! Please check if unit1.js, unit6.js are in the same folder.");
                return;
            }

            // 2. æ ¹æ“š Data ç”Ÿæˆé¸å–®
            let firstKey = null;
            // æ’åºéµå€¼ (è®“ Unit 1, Unit 2... ç…§é †åºæ’)
            const sortedKeys = Object.keys(db).sort();

            sortedKeys.forEach(key => {
                if (!firstKey) firstKey = key;
                let opt = document.createElement('option');
                opt.value = key;
                opt.innerText = db[key].title;
                selector.appendChild(opt);
            });

            // 3. é è¨­è¼‰å…¥ç¬¬ä¸€å€‹å–®å…ƒ (é€šå¸¸æ˜¯ Unit 1)
            if (firstKey) {
                selector.value = firstKey;
                loadUnit(firstKey);
            }
        };

        function loadUnit(unitKey) {
            currentUnitKey = unitKey;
            const unitData = window.grammarDatabase[unitKey];
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = "";

            // ç”Ÿæˆ Tabs (åˆ†é )
            unitData.sections.forEach((sec, index) => {
                let btn = document.createElement('button');
                btn.className = "tab-btn";
                btn.innerText = sec.title;
                btn.onclick = () => loadSection(index);
                // é è¨­ç¬¬ä¸€å€‹ Tab å•Ÿç”¨
                if (index === 0) btn.classList.add('active');
                tabsContainer.appendChild(btn);
            });

            loadSection(0);
        }

        function loadSection(index) {
            currentSectionIndex = index;
            currentQuestionIndex = 0;
            currentData = window.grammarDatabase[currentUnitKey].sections[index];

            // æ›´æ–° UI ç‹€æ…‹ (Tab Highlight)
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            renderQuestion();
        }

        function renderQuestion() {
            // æ¸…ç©ºèˆŠç‹€æ…‹
            document.getElementById('feedback').innerText = "";
            document.getElementById('feedback').style.color = "inherit";
            document.getElementById('btn-next').style.display = "none";
            const interactionArea = document.getElementById('interaction-area');
            interactionArea.innerHTML = "";

            // æª¢æŸ¥æ˜¯å¦çµæŸ
            if (currentQuestionIndex >= currentData.questions.length) {
                finishSection();
                return;
            }

            const qData = currentData.questions[currentQuestionIndex];
            
            // æ›´æ–°é€²åº¦
            document.getElementById('progress').innerText = `${currentQuestionIndex + 1} / ${currentData.questions.length}`;
            
            // æ ¹æ“šé¡Œå‹æ¸²æŸ“
            if (currentData.type === 'choice') {
                renderChoiceGame(qData, interactionArea);
            } else if (currentData.type === 'sorting') {
                renderSortingGame(qData, interactionArea);
            }
        }

        // --- æ¨¡å¼ A: é¸æ“‡é¡Œ (Choice) ---
        function renderChoiceGame(qData, container) {
            // è™•ç†é¡Œç›®æ–‡å­—ï¼šæŠŠ ___ æ›æˆè—è‰²å•è™Ÿï¼Œä¸¦æ”¯æ´ HTML (å¦‚ <br>)
            let displayHtml = qData.q.replace(/___/g, "<span style='border-bottom:3px solid #3498db; padding:0 5px; color:#3498db;'>?</span>");
            document.getElementById('question-display').innerHTML = displayHtml;
            
            const grid = document.createElement('div');
            grid.className = 'options-grid';
            
            qData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(btn, opt, qData.a);
                grid.appendChild(btn);
            });
            container.appendChild(grid);
        }

        // --- æ¨¡å¼ B: åˆ†é¡é¡Œ (Sorting) ---
        function renderSortingGame(qData, container) {
            document.getElementById('question-display').innerText = currentData.instructions;
            
            // é¡¯ç¤ºè¦åˆ†é¡çš„å­— (å¤§å­—)
            const itemDiv = document.createElement('div');
            itemDiv.className = 'sorting-item';
            itemDiv.innerText = qData.q;
            container.appendChild(itemDiv);

            // é¡¯ç¤ºç±ƒå­
            const bucketContainer = document.createElement('div');
            bucketContainer.className = 'buckets-container';
            
            currentData.buckets.forEach(bucketName => {
                const btn = document.createElement('button');
                btn.className = 'bucket-btn';
                btn.innerText = bucketName;
                btn.onclick = () => checkAnswer(btn, bucketName, qData.a);
                bucketContainer.appendChild(btn);
            });
            container.appendChild(bucketContainer);
        }

        // --- é€šç”¨æª¢æŸ¥é‚è¼¯ ---
        function checkAnswer(btn, userAns, correctAns) {
            const feedback = document.getElementById('feedback');
            
            // é–å®šæ‰€æœ‰æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡é»æ“Š
            const allBtns = document.querySelectorAll('#interaction-area button');
            allBtns.forEach(b => b.disabled = true);

            if (userAns === correctAns) {
                // ç­”å°
                if (currentData.type === 'sorting') btn.classList.add('correct-bucket');
                else btn.classList.add('correct');
                
                feedback.innerText = "Correct! Great Job! ğŸ‰";
                feedback.style.color = "var(--success)";
                speak(userAns);
            } else {
                // ç­”éŒ¯
                if (currentData.type === 'sorting') btn.classList.add('wrong-bucket');
                else btn.classList.add('wrong');
                
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆæç¤º
                // å¦‚æœæ˜¯é¸æ“‡é¡Œï¼ŒæŠŠæ­£ç¢ºçš„æŒ‰éˆ•æ¨™æˆç¶ è‰²
                if (currentData.type === 'choice') {
                    allBtns.forEach(b => {
                        if (b.innerText === correctAns) b.classList.add('correct');
                    });
                }

                feedback.innerText = `Oops! The answer is "${correctAns}"`;
                feedback.style.color = "var(--accent)";
                speak("Try again");
            }
            
            // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
            document.getElementById('btn-next').style.display = "inline-block";
        }

        function nextQuestion() {
            currentQuestionIndex++;
            renderQuestion();
        }

        function finishSection() {
            document.getElementById('question-display').innerText = "All Done! ğŸ‰";
            document.getElementById('interaction-area').innerHTML = `
                <div style="margin-top:20px; color:#555; font-size: 1.1em;">
                    You've completed this section.<br>
                    <span style="font-size:0.8em; color:#999;">Select another tab or unit to continue.</span>
                </div>
            `;
            document.getElementById('progress').innerText = "";
            speak("Excellent work!");
        }

        function speak(text) {
            // ç°¡å–®çš„èªéŸ³åˆæˆ
            window.speechSynthesis.cancel();
            let utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            window.speechSynthesis.speak(utter);
        }

    </script>
</body>
</html>